digraph control_fsm {
  rankdir=TB;
  node [shape=box, style=filled];

  labelloc="t";
  label="RISC-V Control FSM\n36 States, Multi-Cycle Architecture";
  fontsize=16;

  FETCH_0 [fillcolor=lightblue, shape=doublecircle];
  FETCH_1 [fillcolor=lightblue, shape=box];
  FETCH_2 [fillcolor=lightblue, shape=box];
  FETCH_3 [fillcolor=lightblue, shape=box];
  DECODE [fillcolor=yellow, shape=box];
  BRANCH_0 [fillcolor=lightcoral, shape=box];
  BRANCH_T [fillcolor=lightcoral, shape=box];
  PC_INC [fillcolor=lightcoral, shape=box];
  JAL_0 [fillcolor=lightcoral, shape=box];
  JAL_1 [fillcolor=lightcoral, shape=box];
  REG_REG [fillcolor=lightgreen, shape=box];
  REG_IMM [fillcolor=lightgreen, shape=box];
  LUI_0 [fillcolor=lightgreen, shape=box];
  AUIPC_0 [fillcolor=lightgreen, shape=box];
  JALR_0 [fillcolor=lightcoral, shape=box];
  JALR_1 [fillcolor=lightcoral, shape=box];
  LD_0 [fillcolor=lightyellow, shape=box];
  LD_1 [fillcolor=lightyellow, shape=box];
  LD_2 [fillcolor=lightyellow, shape=box];
  LD_3 [fillcolor=lightyellow, shape=box];
  LD_4 [fillcolor=lightyellow, shape=box];
  ST_0 [fillcolor=lightyellow, shape=box];
  ST_1 [fillcolor=lightyellow, shape=box];
  ST_2 [fillcolor=lightyellow, shape=box];
  ST_3 [fillcolor=lightyellow, shape=box];
  CSR_0 [fillcolor=lavender, shape=box];
  CSR_1 [fillcolor=lavender, shape=box];
  TRAP_ENTRY_0 [fillcolor=lavender, shape=box];
  TRAP_ENTRY_1 [fillcolor=lavender, shape=box];
  TRAP_ENTRY_2 [fillcolor=lavender, shape=box];
  TRAP_ENTRY_3 [fillcolor=lavender, shape=box];
  TRAP_ENTRY_4 [fillcolor=lavender, shape=box];
  MRET_0 [fillcolor=lavender, shape=box];
  FENCE_0 [fillcolor=lightcoral, shape=box];
  ERROR_INVALID_OPCODE [fillcolor=red, shape=octagon];
  ERROR_OPCODE_NOT_IMPLEMENTED [fillcolor=red, shape=octagon];

  FETCH_0 -> FETCH_1 [];
  FETCH_1 -> FETCH_1 [label="!mem_resp", color=blue, style=dashed];
  FETCH_1 -> FETCH_2 [label="mem_resp"];
  FETCH_2 -> FETCH_3 [];
  FETCH_3 -> DECODE [];
  DECODE -> LUI_0 [label="LUI"];
  DECODE -> AUIPC_0 [label="AUIPC"];
  DECODE -> JAL_0 [label="JAL"];
  DECODE -> JALR_0 [label="JALR"];
  DECODE -> BRANCH_0 [label="BRANCH"];
  DECODE -> LD_0 [label="LD"];
  DECODE -> ST_0 [label="ST"];
  DECODE -> REG_IMM [label="ALUI"];
  DECODE -> REG_REG [label="ALU"];
  DECODE -> MRET_0 [label="ECSR & MRET"];
  DECODE -> TRAP_ENTRY_0 [label="ECSR & ECALL/EBREAK"];
  DECODE -> CSR_0 [label="ECSR & CSR ops"];
  DECODE -> ERROR_INVALID_OPCODE [label="invalid opcode", color=red];
  BRANCH_0 -> PC_INC [label="not taken"];
  BRANCH_0 -> BRANCH_T [label="taken"];
  BRANCH_T -> FETCH_0 [];
  PC_INC -> FETCH_0 [];
  JAL_0 -> JAL_1 [];
  JAL_1 -> FETCH_0 [];
  REG_REG -> PC_INC [];
  REG_IMM -> PC_INC [];
  LUI_0 -> PC_INC [];
  AUIPC_0 -> PC_INC [];
  JALR_0 -> JALR_1 [];
  JALR_1 -> FETCH_0 [];
  LD_0 -> LD_1 [];
  LD_1 -> LD_2 [];
  LD_2 -> LD_2 [label="!mem_resp", color=blue, style=dashed];
  LD_2 -> LD_3 [label="mem_resp"];
  LD_3 -> LD_4 [];
  LD_4 -> PC_INC [];
  ST_0 -> ST_1 [];
  ST_1 -> ST_2 [];
  ST_2 -> ST_3 [];
  ST_3 -> ST_3 [label="!mem_resp", color=blue, style=dashed];
  ST_3 -> PC_INC [label="mem_resp"];
  CSR_0 -> ERROR_OPCODE_NOT_IMPLEMENTED [label="!csr_valid", color=red];
  CSR_0 -> CSR_1 [label="csr_valid"];
  CSR_1 -> PC_INC [];
  TRAP_ENTRY_0 -> TRAP_ENTRY_1 [];
  TRAP_ENTRY_1 -> TRAP_ENTRY_2 [];
  TRAP_ENTRY_2 -> TRAP_ENTRY_3 [];
  TRAP_ENTRY_3 -> TRAP_ENTRY_4 [];
  TRAP_ENTRY_4 -> FETCH_0 [];
  MRET_0 -> FETCH_0 [];
  DECODE -> FENCE_0 [label="FENCE"];
  FENCE_0 -> PC_INC [];
  ERROR_INVALID_OPCODE -> ERROR_INVALID_OPCODE [color=blue, style=dashed];
  ERROR_OPCODE_NOT_IMPLEMENTED -> ERROR_OPCODE_NOT_IMPLEMENTED [color=blue, style=dashed];

  subgraph cluster_legend {
    label="Legend";
    style=filled;
    color=white;

    legend_fetch [label="Fetch States", fillcolor=lightblue, shape=box];
    legend_decode [label="Decode", fillcolor=yellow, shape=box];
    legend_alu [label="ALU Ops", fillcolor=lightgreen, shape=box];
    legend_control [label="Control Flow", fillcolor=lightcoral, shape=box];
    legend_memory [label="Memory Ops", fillcolor=lightyellow, shape=box];
    legend_csr [label="CSR/Trap", fillcolor=lavender, shape=box];
    legend_error [label="Error States", fillcolor=red, shape=octagon];

    legend_fetch -> legend_decode [style=invis];
    legend_decode -> legend_alu [style=invis];
    legend_alu -> legend_control [style=invis];
    legend_control -> legend_memory [style=invis];
    legend_memory -> legend_csr [style=invis];
    legend_csr -> legend_error [style=invis];
  }
}
